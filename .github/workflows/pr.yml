name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    name: Validate Pull Request
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for changed files
        id: changed-files
        run: |
          if git diff --name-only origin/main...HEAD | grep -E '^(apps/|packages/)'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate package versions
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          echo "Checking for version changes in modified packages..."
          # This is a placeholder - implement actual version validation if using changesets

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
          requireScope: false

      - name: Check for merge conflicts
        run: |
          if git diff --check origin/main...HEAD; then
            echo "No merge conflicts detected"
          else
            echo "Merge conflicts detected"
            exit 1
          fi

      - name: Validate commit messages
        run: |
          # Check that commits follow conventional commits format
          git log --format=%s origin/main..HEAD | while read commit_msg; do
            if ! echo "$commit_msg" | grep -E '^(feat|fix|docs|style|refactor|perf|test|build|ci|chore)(\(.+\))?: .+'; then
              echo "Invalid commit message: $commit_msg"
              echo "Commit messages should follow conventional commits format"
              exit 1
            fi
          done

      - name: Check file size limits
        run: |
          # Warn about large files (>1MB)
          git diff --name-only origin/main...HEAD | while read file; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              if [ $size -gt 1048576 ]; then
                echo "Warning: Large file detected: $file ($(($size / 1024))KB)"
              fi
            fi
          done

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level=high || echo "Security vulnerabilities found"

      - name: Check for secrets in code
        run: |
          # Basic check for common secrets patterns
          if git diff origin/main...HEAD | grep -iE '(api[_-]?key|password|secret|token).*=.*["\x27][A-Za-z0-9]{20,}'; then
            echo "Potential secrets detected in diff"
            exit 1
          fi
